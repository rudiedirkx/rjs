<!doctype html>
<html>

<head>
<style>
ul {
	-webkit-columns: 4;
	-moz-columns: 4;
	columns: 4;
	list-style: none;
	padding: 0;
}
li {
	display: block;
	padding: 0;
}
label {
	display: inline-block;
	padding: 1px 1px;
	background: #faa;
}
.checked {
	background: #afa;
}
pre {
	tab-size: 4;
}
</style>
</head>

<body onload="init()">

<p>
	(<a id=save href="#">save</a>)
	<button disabled>Download</button>
	<span>?</span> KB / ~ <span>?</span> KB <a target=_blank href="http://marijnhaverbeke.nl/uglifyjs">minified</a>
</p>

<pre id=code></pre>

<script src="rjs.js"></script>
<script>
"use strict";

var deps, $button, $save, source, waiting = 2;

function setSize(length) {
	$button
		.getNext().setText(Math.ceil(length / 100) / 10)
		.getNext().setText(Math.ceil(0.55 * length / 100) / 10);
}

function build(size) {
	var code = source;

	// Don't add what's checked. Remove what's not.
	$$('input:not(:checked)').each(function(inp) {
		var name = inp.name;
		var regex = new RegExp('\\/\\* <' + name + ' \\*\\/[\\s\\S]+?\\/\\* ' + name + '> \\*\\/', 'g');
		code = code.replace(regex, '');
	});

	code = code.replace(/\/\*[\s\S]+?\*\//g, '').replace(/\/\/ .+/g, '').replace(/\t+[\r\n]/g, '').trim();
	$('code').setText(code);

	size && setSize(code.length);

	return code;
}

function createTable(deps) {
	var ul = document.el('ul');
	$each(deps, function(x, name) {
		var check = name[0] == '_' ? '' : 'checked';
		document.el('li').setHTML('<label class="' + check + '"><input type=checkbox name="' + name + '" ' + check + ' disabled> ' + name + '</label>').inject(ul);
	});

	ul.on('change', 'input[type=checkbox]', function(e) {
		cbColor(cb);
		build(true);
	});

	return ul;
}

function cbColor(cb) {
	cb.parentNode.removeClass('checked').removeClass('unchecked').addClass(cb.checked ? 'checked' : 'unchecked');
}

function reinState() {
	if ( location.hash.length > 1 ) {
		var state = location.hash.substr(1).split(',');
		state.forEach(function(name) {
			var checked = '+' == name[0],
				cb = $('input[name="' + name.substr(1) + '"]', 1);
			if ( cb ) {
				cb.checked = checked;
				cbColor(cb);
			}
		});
	}
}

function ready() {
	$$('[disabled]').attr('disabled', null);
	build(true);
}

function init() {
	$button = $('button', 1);
	$save = $('save');

	$.get('deps.json').on('success', function(e) {
		deps = JSON.parse(this.responseText.validJSON());

		createTable(deps).injectTop(document.body);
		reinState();

		--waiting || ready();
	});

	$.get('rjs.js').on('success', function(e) {
		source = this.responseText;

		--waiting || ready();
	});

	$button.on('click', function(e) {
		var code = build(true),
			blob = new Blob([code], {type: 'text/javascript'}),
			uri = URL.createObjectURL(blob),
			a = document.el('a', {href: uri, download: 'rjs-custom.js'});
		a.click();
	});

	$save.on('click', function(e) {
		var state = [];
		$$('ul input[type=checkbox]').each(function(el) {
			if ( el.checked != el.defaultChecked ) {
				state.push((el.checked ? '+' : '-') + el.name);
			}
		});
		this.href = '#' + state.join(',');
	});
}

$extend(String, {
	validJSON: function() {
		return this.replace(/(\w+):/g, '"$1":').replace(/'/g, '"');
	}
});
</script>

</body>

</html>
